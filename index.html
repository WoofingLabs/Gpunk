<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPunks 查询器（合约直接查询）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background:#070808; color:white; font-family:system-ui,sans-serif; }
        input::placeholder { color:#666; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="fixed top-0 w-full bg-black/80 backdrop-blur z-10 border-b border-blue-500/30">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
            <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" class="w-10 h-10 rounded-full">
            <h1 class="text-2xl font-bold text-blue-400">GPunks 查询器</h1>
        </div>
    </header>

    <main class="flex-1 pt-20 pb-10 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="bg-zinc-900 rounded-2xl p-6 mb-8 shadow-2xl border border-blue-500/30">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input id="addr" type="text" placeholder="输入钱包地址 0x..." class="flex-1 px-5 py-4 bg-black/50 rounded-xl border border-blue-500/50 focus:border-green-400 outline-none text-lg">
                    <button id="go" class="px-10 py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg transition">查询</button>
                </div>
            </div>

            <div id="loading" class="text-center text-gray-400 hidden">加载中...</div>
            <div id="count" class="text-center text-2xl mb-6 hidden">
                共持有 <span id="num" class="text-green-400 font-bold">0</span> 个 GPunks
            </div>
            <div id="grid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-8 gap-5"></div>
            <div id="empty" class="text-center text-2xl text-gray-500 py-20 hidden">这个地址没有 GPunks</div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const CONTRACT = "0x145Af7ED86863F914652791b8A6028B92411baD4";
        const web3 = new Web3("https://gatelayer-mainnet.gatenode.cc/");
        const abi = [
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string"}],"stateMutability":"view","type":"function"}
        ];
        const nft = new web3.eth.Contract(abi, CONTRACT);

        document.getElementById("addr").addEventListener("keypress", e => e.key === "Enter" && query());
        document.getElementById("go").onclick = query;

        async function query() {
            let address = document.getElementById("addr").value.trim();
            if (!web3.utils.isAddress(address)) return alert("地址格式错误");

            document.getElementById("loading").classList.remove("hidden");
            document.getElementById("grid").innerHTML = "";
            document.getElementById("count").classList.add("hidden");
            document.getElementById("empty").classList.add("hidden");

            try {
                const balance = Number(await nft.methods.balanceOf(address).call());
                if (balance === 0) throw "no nft";

                document.getElementById("num").textContent = balance;
                document.getElementById("count").classList.remove("hidden");

                const ids = [];
                for (let i = 0; i < balance; i++) {
                    const id = await nft.methods.tokenOfOwnerByIndex(address, i).call();
                    ids.push(id);
                }

                const grid = document.getElementById("grid");

                for (const id of ids) {
                    // 直接调用合约的 tokenURI
                    const uri = await nft.methods.tokenURI(id).call();
                    let imgUrl = "";

                    try {
                        if (uri) {
                            // 如果 URI 是 .json，fetch 提取 image
                            if (uri.endsWith('.json')) {
                                const resp = await fetch(uri);
                                if (resp.ok) {
                                    const meta = await resp.json();
                                    imgUrl = meta.image;
                                    if (imgUrl.startsWith("ipfs://")) {
                                        imgUrl = "https://ipfs.io/ipfs/" + imgUrl.slice(7);
                                    }
                                }
                            } else {
                                // 直接图片
                                imgUrl = uri;
                            }
                        }
                    } catch (e) { 
                        console.error('Metadata fetch failed for', id, e);
                        // 兜底：尝试 baseURI + id + .png（如果已知 baseURI）
                        imgUrl = `https://bafybeiam2yfk274nkndkks33k7exisutily5h5msbtpqp3wyrlxg2x4q5q.ipfs.w3s.link/${id}.png`;
                    }

                    if (!imgUrl) {
                        imgUrl = `https://via.placeholder.com/500x500/111827/ffffff?text=%23${id}`;
                    }

                    const div = document.createElement("div");
                    div.className = "relative group overflow-hidden rounded-xl border border-blue-500/30 hover:border-green-400 transition-all aspect-square";
                    div.innerHTML = `
                        <img src="${imgUrl}" alt="GPunks #${id}" loading="lazy"
                             class="w-full h-full object-cover bg-gray-900"
                             onerror="this.src='https://via.placeholder.com/500x500/111827/ffffff?text=%23${id}'; this.onerror=null;">
                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 to-transparent p-3 text-center opacity-0 group-hover:opacity-100 transition">
                            <span class="font-bold text-lg">#${id}</span>
                        </div>
                    `;
                    grid.appendChild(div);
                }

            } catch (e) {
                console.error(e);
                document.getElementById("empty").classList.remove("hidden");
            } finally {
                document.getElementById("loading").classList.add("hidden");
            }
        }
    </script>
</body>
</html>
